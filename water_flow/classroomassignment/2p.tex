\documentclass[12pt, a4paper, fleqn]{jreport}

\usepackage{graduatethesis}
\usepackage{listings,jlisting}
\usepackage{cite}
\usepackage{here}


\makeatletter
%\def\@cite#1{$\m@th^{\hbox{\@ove@rcfont #1）}}$}
\makeatother

\title{最大の移動時間を最小化する教室割当問題の\\定式化と求解}
\author{都11-23　岡崎　俊介}
\date{平成27年2月13日}
\西暦

\begin{document}
\maketitle
\setcounter{tocdepth}{2}
\setlength{\mathindent}{0zw}
\pagenumbering{roman}
\tableofcontents
\newpage
\pagenumbering{arabic}
\setcounter{totalnumber}{3}
\setcounter{topnumber}{3}
\renewcommand{\topfraction}{0.99}
\renewcommand{\bottomfraction}{0.99}
\renewcommand{\textfraction}{0.0}

\lstset{
  basicstyle={\ttfamily},
  breaklines=true,
  columns=[l]{fullflexible},
  lineskip=-0.5zw,
}

\setlength{\textwidth}{\paperwidth}   %%本文を用紙の横サイズにする
\addtolength{\textwidth}{-2in}         %それを2インチ引く
\setlength{\textheight}{\paperheight} %%本文を用紙の縦サイズにする
\addtolength{\textheight}{-2in}        %それを2インチ引く
\setlength{\topmargin}{0pt}            %ページ上端の余白を消す
\addtolength{\topmargin}{-\headheight} %(ページ上端の余白)-(ヘッダーの高さ)
\addtolength{\topmargin}{-\headsep}    %                  -(ヘッダーと本文の余白)
\setlength{\oddsidemargin}{0pt}       %%奇数(右)ページの左余白消す
\setlength{\evensidemargin}{0pt}      %%偶数(左)ページの左余白を消す



\chapter{はじめに}
人は，移動をする生き物である．
移動をして，様々な目的地へ赴き，やりたいこと，またはしなければならないことをする．
移動には，ピクニックのように移動そのものを楽しむ場合，すなわち移動そのものが目的である場合と，通勤や通学のように時間がもったいないが移動しなければならない場合，すなわち移動が別の目的のための手段となっている場合がある．

移動が別の目的のための手段となっている場合の1つに，大学内での教室移動がある．
大学内での教室移動は，授業と授業の間の休み時間に行うため，休み時間を移動に費やすことになる．
短い休み時間で休憩，及び授業の準備も行わなければならない学生にとっては，移動時間はできるだけ短いほうが望ましい．

通常，大学では授業によって開講される教室が異なっており，どの授業にどの教室を割り当てるかは手動で決めることが多い．
実際，現在関西大学においても，授業に対する教室の割当は全て手動で行われている．
また，関西大学では多くの学部が授業を開講するため，教室を割り当てる際に学生の移動時間まで考慮することは難しい．

この問題に似た問題として，大学における時間割作成の自動化が挙げられる．
この問題についての研究は数多く存在している．\cite{dadasenko,dadasan}．
そこで本研究では，一般的な割当問題\cite{ハンドブック}の枠組みの下で授業に対する教室の割当を自動化する手法を考えることにする．
このような問題を本研究では教室割当問題と呼ぶことにする．

教室割当の自動化については，例えば，マルチエージェントシミュレーションを行い，学生の移動時間を最小化した教室配置を行う研究がある\cite{kurousitemituketa}.
これに対し本研究では，移動時間が最小になる教室の割り当て方を求める．
具体的には教室割当問題を最適化問題として定式化し，最適化ソルバーを用いてそれを解くことを試みる．

実は\cite{先行研究}でも同じような研究が行われており，学生の移動時間の総和を最小化するような教室割当を求めることを目標とした最適化問題を解いている．
この最適化問題は，授業・教室・履修者の基本的なデータがあれば計算を行うことができるため，大学毎の授業システムに影響されず，多くの大学で使用可能な汎用性の高い教室割当が可能になる．
しかしながら，\cite{先行研究}の提案手法が大きな計算時間を要するものであり，最適解を求めることができないケースが多く見られた．

そこで本研究では，\cite{先行研究}とは目的を変更し，学生の移動時間の最大値を最小にするような教室割当を求めることを目指す．




\input{junbi.tex}


\chapter{先行研究の概要}
本研究では，最大の移動時間を最小化する教室割当問題を行うが，これは先行研究\cite{先行研究}を参考にしたものである．
本章では，\cite{先行研究}の概要について説明する．
\section{背景}
現在，関西大学では手動で教室割当を行っている．
関西大学には約3万人の学生が在籍しており，約12000の授業がある．
このような多数の学生と授業を手動で処理し，移動時間を最小化する教室割当を行うことは非常に困難である．
また，休み時間には多くの学生が同時に移動するため，学生の動きを考慮した教室割当を行わなければ移動時に混雑が発生することがある．
さらに，現在の関西大学の休み時間は10分と短く，連続して授業を持つ学生や教員は，次の授業への移動と準備を時間内に行うことが困難なことがある．
そこで，先行研究では次のことを目標としていた．\\
\begin{center}
\fbox{
\begin{tabular}{c}
各授業の開講曜限が定められているとき，休み時間における全学生の\\移動時間の総和が最小となるような，授業に対する教室の割当を求めよ．
\end{tabular}
}
\end{center}
\vspace{5.0mm}
すなわち，先行研究では本大学の教室割当を自動化するとともに，余裕を持って移動を行えるように各学生の移動時間の総和を最小化する最適化問題を定式化し，求解を行った．

先行研究では各時限間の教室移動時間を最適化対象としているが，1，2限（午前）と3，4，5限（午後）の間には昼休みがあり，長い休みとなるので，移動時間を最小化する必要性はないと考えている．
そこで，先行研究では一日を午前・午後に分けて最適化を行っている．
さらに一週間は月曜から土曜の6日間，そして一年は春，秋の学期に分けられるので，最適化の対象は合計24通りとなる．

\if0
\section{解法}
先行研究では，移動時間が最小になることを考慮した教室割当問題を数理計画問題として定式化し，既に作成されている時間割のデータを用いて求解している．
具体的には，教室割当問題を重み付き制約充足問題（WCSP）として扱っている．
%具体的に得られる解が教室割当として成り立たせるために不可欠となる制約を絶対制約（必ず守るべき制約），より良い組み合わせを生むための制約を考慮制約（できるだけ守りたい制約）として扱っている．
また，先行研究では，定式化した数理計画問題を解くために，厳密解法を用いている．
厳密解法とは，最適化問題に対して，最適性の保証された解（最適解）を求める解法のことである．
厳密解法には，混合整数計画問題に対する分枝限定法，分枝価格法などがある．

\fi


\section{問題の定式化}
先行研究では以下のように教室割当問題を定式化して最適化を行っている．
\begin{itemize}
\item 集合と添字・パラメータ・変数
\begin{itemize}
\item 集合・添字\\
\begin{tabular}{ll}
$p \in P$    &: 時限とその集合\\
$j \in J$    &: 授業とその集合\\
$j \in J1_p$ &: $p$限目に開講される授業とその集合\\
$j \in L$    &: 特別連続授業とその集合\\
$(i,j) \in D$&: 特定の教室を指定する特定の授業の組とその集合\\
$i \in I$    &: 教室とその集合\\
\end{tabular}
\item パラメータ
\[
\begin{array}{rcl}
b & = &
\begin{array}{ll}
\mbox{休み時間の長さ} 
\end{array}
\\
m_{i} & = & 
\begin{array}{ll}
 \mbox{教室$i$の定員数} 
\end{array}
\\
n_{j} & = & 
\begin{array}{ll}
 \mbox{授業$j$の受講者数} 
\end{array}
\\
y & = & 
\begin{array}{ll}
 \mbox{混雑が起きる可能性が高まる移動時間} 
\end{array}
\\
q_{i_1,i_2} & = & 
\begin{array}{ll}
 \mbox{授業$i_1$と授業$i_2$の双方を受講する学生数} 
\end{array}
\\
r & = & 
\begin{array}{ll}
 \mbox{全ての移動で可能な限り守りたい移動時間} 
\end{array}
\\
t_{i_1,i_2} & = & 
\begin{array}{ll}
 \mbox{教室$i_1$と教室$i_2$間での所要移動時間} 
\end{array}
\\
z & = & 
\begin{array}{ll}
 \mbox{混雑が起きると予測される人数} 
\end{array}
\\
d_{j_1,j_2} & = & \left\{ 
\begin{array}{ll}
	1, & \mbox{$p$限目に授業$j_1$を，$(p+1)$限目に授業$j_2$を受講する学生が存在するとき} 		\\
	0, & \mbox{それ以外}
\end{array}
\right. \\
e_{p,j} & = & \left\{ 
\begin{array}{ll}
	1, & \mbox{時限$p$時に授業$j$が割り当てられているとき} 		\\
	0, & \mbox{それ以外}
\end{array}
\right. \\
f_{i_1,i_2} & = & \left\{ 
\begin{array}{ll}
1, & \mbox{$t_{i_1,i_2}\leq y$であるとき} \\
0, & \mbox{それ以外}
\end{array}
\right.\\
g_{i_1,i_2} & = & \left\{ 
\begin{array}{ll}
1, & \mbox{$t_{i_1,i_2}>r$であるとき} \\
0, & \mbox{それ以外}
\end{array}
\right.\\
h_{j} & = & \left\{ 
\begin{array}{ll}
1, & \mbox{$p$限目に授業を持たず，$(p+1)$限目に授業$j$を受講する学生が存在するとき} \\
0, & \mbox{それ以外}
\end{array}
\right.\\
\end{array}
\]
\vspace{3.0mm}
\item 変数\\
\vspace{-5.0mm}
\[
\begin{array}{rcl}
v_{i_1,i_2} & = & 
\begin{array}{ll}
\mbox{ある時限に教室$i_1$で授業が開講され，}\\
\mbox{その次の時限に教室$i_2$で授業が開講されているとき，その両方を受講している学生数}\\ 
\end{array}
\\
 u_{i,j} & = & \left\{ 
\begin{array}{ll}
1, & \mbox{教室$i$に授業$j$が割り当てられているとき} \\
0, & \mbox{それ以外}
\end{array}
\right. 
\\
w_{p,i_1,i_2} & = & \left\{ 
\begin{array}{ll}
1, & \mbox{$p$限目に教室$i_1$で授業が開講され,}\\
& \mbox{$(p+1)$限目に教室$i_2$で授業が開講されるとき}\\ 
0, & \mbox{それ以外}
\end{array}
\right.
\\
\alpha_{j_1,j_2} & = & \left\{ 
\begin{array}{ll}
1, & \mbox{特別連続授業$j_1,j_2$が異なる教室で開講されるとき}\\
0, & \mbox{それ以外}
\end{array}
\right.
\\
\beta_{j_1,j_2} & = & \left\{ 
\begin{array}{ll}
1, & \mbox{授業$j_1,j_2$間での移動時間ができるだけ守りたい指定の時間を越えるとき}\\
0, & \mbox{それ以外}
\end{array}
\right.
\\
 \delta_{i,j_1,j_2} & = & \left\{ 
\begin{array}{ll}
1, & \mbox{$p$限目に授業$j$を受講していて，$(p+1)$限目に授業$j_2$を受講せずに}\\
& \mbox{退室する学生集団と$p$限目に授業$j_1$を受講していて，}\\
& \mbox{$(p+1)$限目に授業$j_2$を受講するために入室してくる学生集団か，}\\
& \mbox{$p$限目に授業を持たず$(p+1)$限目に授業$j_2$を受講するために入室する}\\
& \mbox{学生集団で出入りのタイミングが合い，混雑が起きる可能性が高いとき}\\
& {出入りのタイミングが合い,混雑が起きる可能性が高いとき}\\
0, & \mbox{それ以外}
\end{array}
\right.
\end{array}
\]
\end{itemize}


\item 制約条件
\begin{itemize}
\item{変数を定義する制約条件}
\begin{itemize}
\item $v_{i_1,i_2}$\\
\begin{eqnarray}
\label{shensu-1} 
&&( u_{i_1,j_1} + u_{i_2,j_2} - 1 ) \cdot q_{j_1,j_2} \leq v_{i_1,i_2}\\
&&\hspace{20.0mm} \left(\forall p \in P,\: \forall i_1 \in I,\: \forall i_2 \in I,\:\forall j_1 \in J1_p,\:\forall j_2 \in J1_{p+1},d_{j_1,j_2}=1\right)\nonumber 
\end{eqnarray}
\item $w_{p,i_1,i_2}$\\
\begin{eqnarray}
\label{shensu-2} 
&& u_{i1,j1} + u_{i2,j2} - 1  \leq w_{p,i_1,i_2}\\
&&\hspace{20.0mm} \left(\forall p \in P,\: \forall i_1 \in I,\:\forall i_2 \in I,\:\forall j_1 \in J1_{p},\:\forall j_2 \in J1_{p+1},\:d_{j_1,j_2}=1\right)\nonumber 
\end{eqnarray}
\end{itemize}
\vspace{3.0mm}
\item{絶対制約}\\
\vspace{-3.0mm}
\begin{itemize}
\item {\bf[絶対制約1] : 1つの曜限における各教室には2つ以上の授業を割り当てられない．}\\

\vspace{-5.0mm}
　同じ曜限において，各教室に2つ以上の授業が割り当てられないようにするため，
教室$i$について，次の制約を与える：

\vspace{-3.0mm}
\begin{eqnarray}
\label{szettai-1}
&&\sum_{j \in J} u_{i,j} \cdot e_{p,j} \leq 1 \hspace{5.0mm}
\quad \left (\forall p \in P, \:\forall i \in I \right)
\end{eqnarray} 

\vspace{5.0mm}
\item {\bf[絶対制約2] : 各授業には必ず1つの教室を割り当てなければならない．}\\

\vspace{-5.0mm}
　ある曜限に存在する1つの授業に対して2つ以上の教室を割り当てないようにするため，
また，1つの授業に1つも教室が割り当てられないことを防ぐため，
授業$j$について,次の制約を与える：

\vspace{-3.0mm}
\begin{eqnarray}
\label{szettai-2}
&&\sum_{i \in I} u_{i,j}=1 \quad \left (\forall j \in J \right)
\end{eqnarray} 

\vspace{5.0mm}
\item {\bf[絶対制約3] : 受講人数が教室の定員を超えて教室に授業を割り当ててはいけない．}\\

\vspace{-5.0mm}
　受講人数が各教室の定員を越えないようにするため，
次の制約を与える：

\vspace{-3.0mm}
\begin{eqnarray}
\label{szettai-3}
&&\sum_{i \in I} u_{i,j}\cdot m_{i} \geq n_{j} \quad \left (\forall j \in J\right)
\end{eqnarray}

\vspace{5.0mm}
\item {\bf[絶対制約4] : 特定の授業は指定された教室で開講されなければならない．}\\

\vspace{-5.0mm}
　本制約は，特定の設備を必要とする授業をその設備が整った指定されている教室に割り当てるための制約である．
教室$i$に授業$j$が割り当てられなければならないとき，次の制約を与える：

\vspace{-3.0mm}
\begin{eqnarray}
\label{szettai-4} 
&&u_{i,j}=1 \quad \left(\forall (i,j) \in D\right)
\end{eqnarray}
\end{itemize}

\vspace{5.0mm}
\item 考慮制約\\
\vspace{-3.0mm}
\begin{itemize}
\item {\bf[考慮制約1] : 特別連続授業は同じ教室で開講されることが好ましい．}\\

\vspace{-5.0mm}
　特別連続授業（授業内容が同一，または非常に関連性の高い2限連続で開講される2つの授業）は双方を受講している学生が多く，教室を移動する学生が少ないと考えられるため，そのまま同一の教室で開講されることが好ましい．

\vspace{-3.0mm}
\begin{eqnarray}
\label{skouryo-1}
&&u_{i_1,j_1}+ u_{i_2,j_2}- 1 \leq \alpha_{j_1,j_2} \quad \left((j_1,j_2) \in L \subseteq J \times J,\:i_1 \neq i_2\right)
\end{eqnarray}

\vspace{5.0mm}
\item {\bf[考慮制約2] : 移動時間は指定した時間以内であることが好ましい．}\\

\vspace{-5.0mm}
　本制約は，休み時間をできるだけ授業の準備などに費やせるようにするための制約である．

\vspace{-5.0mm}
\begin{eqnarray}
\label{skouryo-2}
&&w_{p,i_1,i_2}\cdot g_{i_1,i_2} \leq \beta_{j_1,j_2}
\label{eqn:seiyaku_first} \\ 
&& \left(\forall p \in P,\:\forall i_1 \in I,\:\forall i_2 \in I,\:\forall j_1 \in J1_p,\:\forall j_2 \in J1_{p+1}\right)\nonumber 
\end{eqnarray}

\vspace{5.0mm}
\item {\bf[考慮制約3] : 教室内の人が入れ替わる際の混雑ができるだけ発生しないほうが好ましい．}\\

\vspace{-5.0mm}
　移動が行われる教室間の距離が短い場合，移動して教室に入ってくる学生と，授業が終わって教室から出て行く学生の間で混雑が起きる．このような混雑は移動時間の増加につながるためできるだけ避けたいことである．
本制約は以上のような混雑による移動時間の増加をできるだけ避けるための制約である．

\vspace{-3.0mm}
\begin{eqnarray}
\label{skouryo-3}
&&((n_{j}-q_{j,j_2}\cdot d_{j,j_2}) + (q_{j_1,j_2} \cdot d_{j_1,j_2} \cdot f_{i_2,i_1}) \nonumber \\
&&+ (n_{j_2} - q_{j_1,j_2}) \cdot h_{j_2}) \cdot (u_{i_1,j} + u_{i_1,j_2} + u_{i_2,j_1} - 2) \cdot d_{j_1,j_2} - z \\
&&\leq M \cdot \delta_{j,j_1,j_2} \nonumber \\
&&(\forall p \in P,\: \forall i_1 \in I,\: \forall i_2 \in I,\: \forall j \in J1_{p},\: \forall j_1 \in J1_{p},\: \forall j_2 \in J1_{p+1} ,\nonumber\\
&&\hspace{50.0mm}i_1 \neq i_2, \: j \neq j_1,M=十分大きな整数)\nonumber
\end{eqnarray}
\end{itemize}
\end{itemize}

\vspace{5.0mm}
　先行研究では，混雑は授業終了直後に発生するものと考えている．
従って，図\ref{senko-konzatu}のように，混雑の原因となる人数は，該当教室から出て行く人，前の時限に授業がなく次に該当教室で受講している人，前の時限に近くの教室で授業を受けて次に該当教室で受講している人，の3つに限定している．
\begin{figure}[h]
\begin{center}
		\includegraphics[clip,width=10cm]{senkounoito2.eps}
\caption{混雑の対象}
\label{senko-konzatu}
\end{center}	
\end{figure}


以下にこの制約式の左辺の項を示す．
\vspace{3.0mm}
\begin{itemize}
\item 項$(n_{j}-q_{j,j_2}\cdot d_{j,j_2})$\\

\vspace{-3.0mm}
この項は，授業$j$を$p$限に受講している人数から，$(p+1)$限に授業$j_2$を受講している学生の人数を減じることで，授業$j_2$を受講せずに退室している学生の人数を示している．
%しかし，この成分には教室を表す添字$i$が含まれていないので，授業$j$と$j_2$が開講されている対象教室が同じであるということが表現できていない．
\vspace{3.0mm}
\item 項$(q_{j_1,j_2} \cdot d_{j_1,j_2} \cdot f_{i_2,i_1})$\\

\vspace{-3.0mm}
この項は，($p+1$)限に教室$i_1$で開講される授業$j_2$を受講するために，$p$限に授業$j_1$が開講されている教室$i_2$から移動する人がいる場合，
その移動時間が混雑が起きうる移動時間を越えるなら，その移動人数は混雑の要因にならないということを示している．
混雑が起きうる移動時間とは，教室$i_1$から出て行く人や，近くの教室からの移動してくる人とは移動のタイミングが重ならないと考えられる移動時間のことである．
つまり，移動時間が一定以上かかる教室から移動してくる人は，混雑の要因とはならないと考えている．
%先行研究では，周辺いくつかの教室をこの制約の対象として考えているが，この要素では特定の1つの教室しか対象になっていない．
\vspace{3.0mm}
\item 項$ (n_{j_2} - q_{j_1,j_2}) \cdot h_{j_2}$\\

\vspace{-3.0mm}
この項は，$(p+1)$限目に教室$i_1$で開講される授業$j_2$を受講するために外から移動してくる学生数を示している．

\item 項$ (u_{i_1,j} + u_{i_1,j_2} + u_{i_2,j_1} - 2) \cdot d_{j_1,j_2} $\\

\vspace{-3.0mm}
この項は，この制約に関連する授業が同教室で連続して開講されているかを示している．
%要素(b)において，周辺の教室を指定した場合，指定した数だけ変数$u_{i,j}$を増やさなければならない．

\end{itemize}
%この式は,上記の3つの合計人数が混雑が起こると予想される人数$z$人を上回っていれば違反点数が加算されることになっている．


\vspace{3.0mm}

\item 違反点数\\
\vspace{-0.5mm}
考慮制約1, 2, 3が満たされていない場合に発生する違反点数$E_1, E_2, E_3$をそれぞれ(\ref{E_1})，(\ref{E_2})，(\ref{E_3})のように定めている：
\begin{eqnarray}
\label{E_1}
&&E_1= \sum_{j_1,j_2 \in J}\alpha_{j_1,j_2}
\end{eqnarray}
\begin{eqnarray}
\label{E_2}
&&E_2= \sum_{p \in P}\sum_{j_1 \in J1_{p}}\sum_{j_2 \in J1_{p+1}}\beta_{j_1,j_2}
\end{eqnarray}
\begin{eqnarray}
\label{E_3}
&&E_3= \sum_{p \in P}\sum_{j,j_1 \in J1_{p}}\sum_{j_2 \in J1_{p+1}}\delta_{j,j_1,j_2}
\end{eqnarray}

\vspace{5.0mm}
\item 目的関数\\
目的関数は，移動を行う全学生の移動時間の総和と，考慮制約を満たせていない場合に発生する違反点数$E_i(i=1, 2, 3)$にそれぞれの重み係数$a$と$c_i(i=1, 2, 3)$を乗じ，足し合わせた値を最小化するように定めている．
\begin{eqnarray}
&&{\rm minimize} \quad( a \cdot \sum_{i_1 \in I} \sum_{i_2 \in I} (t_{i_1,i_2} \cdot v_{i_1,i_2})) + \sum_{i=1}^{3} c_{i} \cdot E_{i}　\label{eqn:mokuteki}
\end{eqnarray}
\end{itemize}

\section{使用教室と対象授業}
先行研究では，以下のデータを用いて最適化を行っている．
\begin{itemize}
\item 使用教室\\
第4学舎で使用されている一般教室である39教室を対象としている（表\ref{senkoukyousitu}）．
\begin{table}[!h]
\begin{center}
\caption{先行研究で扱っている教室}
\label{senkoukyousitu}
\begin{tabular}{|c|c|c|c|c|}
\hline
1階 & 2階 & 3階 & 4階 & その他\\
\hline\hline
4-101  &   4-201A & 4-301  &  4-401  &  4-502 \\
4-102  &   4-202  & 4-302  &  4-402  &  4-3101\\
4-103  &   4-203  & 4-303  &  4-403  &  4-3201\\
4-104  &   4-204  & 4-304  &  4-404  &  4-3202\\
4-105  &   4-205  & 4-305  &  4-405  &  4-4A  \\
4-106  &   4-206  & 4-306  &  4-406  &  4-4B  \\
4-107  &   4-207  & 4-307  &  4-407  &        \\
       &   4-208  & 4-308  &  4-408  &        \\
       &   4-209  &        &         &        \\
       &   4-210  &        &         &        \\
\hline
\end{tabular}
\end{center}
\end{table}

\item 対象授業\\
理工系学部の全授業を対象としている．
しかし，OD教室などの特殊教室で開講される授業は除いている．
\end{itemize}

\section{計算環境}
先行研究では，最適化ソルバーIBM ILOG CPLEX Optimizerの分枝限定法を用いて求解を行っている．
また，表\ref{senko-kankyo}は，先行研究で用いた計算環境を示している．
\vspace{-7.0mm}
\begin{table}[H]
\begin{center}
\caption{先行研究での計算環境}
\label{senko-kankyo}
\scalebox{1.0}{ 
\begin{tabular}{cc}
\hline
OS & Microsoft Windows 7 Service Pack 1\\
CPU &Intel(R) Core(TM) i7-3930K CPU @ 3.20GHz\\ 
メモリ & 32.0 GB\\
%システム & 64ビット オぺレーティング システム\\
ソルバー1&GLPK 4.47\\
ソルバー2&IBM ILOG CPLEX 12.4.0.0\\
\hline
\end{tabular}
}
\end{center}
\end{table}


\section{実験結果}
先行研究では，まず，計算時間を制限することなく実験を行った．
しかし，約5日間に渡って計算を行い，最適解を得ることができなかった．
そのため，先行研究では，各データに対する計算時間の上限を1時間として実験を行っている．
その際，特定の教室を指定する授業は設定せず，違反係数は移動時間の最小化を優先するために$c_1=1,\, c_2=2,\, c_3=3$を与えている．

表\ref{senkou_kekka}は，先行研究での実験の結果を示している．
表\ref{senkou_kekka}より，最適解を求めることができたのは6ケースしかないということがわかる．

\if0
\begin{table}[H]
\begin{center}
\caption{先行研究での実験結果}
\label{senkou_kekka}
\scalebox{0.9}{
  \begin{tabular}{cr|ccccccccc}
\hline
最適解& \multicolumn{1}{c|}{曜限} & 制約 & 変数(0-1，整数) & nonzeros & \#1(秒) & \#2 & GAP & 計算時間(秒)\\
\hline\hline
F&春学期月曜午前 & 933306 & 4781(3320,1461) & 3649805 & 40.72 & 17248 & 100\% & 3604.03\\
F&午後 & 1156836 & 5987(4506,1481) & 4525582 & 76.05 & 58499 & 97.12\% & 3613.53 \\
F&春学期火曜午前 & 648062 & 4639(3164,1475) & 2548567 & 42.23 & 4315 & 100\% & 3603.72\\
F&午後 & 731761 & 4799(3317,1482) & 2853373 & 36.89 & 17771 & 100\% & 3605.06 \\
F&春学期水曜午前 & 595910 & 4292(2813,1479) & 2327640 & 31.37 & 9381 & 100\% & 3601.08 \\
F&午後 & 678082 & 4476(2994,1482) & 2634793 & 34.26 & 11250 & 100\% & 3600.13 \\
F&春学期木曜午前 & 192757 & 2799(1405,1394) & 744925 & 5.52 & 856 & 88.58\% & 3602.25 \\
F&午後 & 411239 & 3711(2231,1480) & 1590013 & 15.69 & 5510 & 100\% & 3600.21 \\
F&春学期金曜午前 & 200266 & 3142(1773,1369) & 772967 & 11.11 & 1379 & 13.32\% & 3604.11 \\
F&午後 & 871766 & 4981(3500,1481) & 3391847 & 43.74 & 43244 & 100\% & 3601.69 \\
T&春学期土曜午前& 36822 & 2628(1362,1266) & 133617 & 1.68 & 531 & 0.80\% & 225.23 \\
T&午後 & 48320 & 2703(1221,1482) & 171653 & 1.96 & 194 & 4.64\% & 1282.27 \\
\hline
F&秋学期月曜午前 & 706638 & 4235(2753,1482) & 2758070 & 31.90 & 9307 & 100\% & 3605.15 \\
F&午後 & 1026116 & 5861(4379,1482) & 4003702 & 75.78 & 73147 & 100\% & 3606.85 \\
F&秋学期火曜午前 & 888258 & 4922(3479,1443) & 3491939 & 51.00 & 24275 & 100\% & 3606.29 \\
F&午後 & 926884 & 4835(3353,1482) & 3606133 & 42.28 & 50741 & 100\% & 3601.60 \\
F&秋学期水曜午前 & 469738 & 3756(2312,1444) & 1832968 & 19.91 & 3295 & 100\% & 3603.42 \\
F&午後 & 723830 & 4719(3244,1475) & 2827852 & 40.08 & 7538 & 100\% & 3604.06 \\
T&秋学期木曜午前 & 80847 & 3063(1581,1482) & 306626 & 3.54 & 621 & 8.37\% & 752.94 \\
F&午後 & 815102 & 4724(3242,1482) & 3164290 & 36.33 & 11695 & 100\% & 3602.20 \\
T&秋学期金曜午前 & 77837 & 2861(1379,1482) & 296246 & 4.93 & 1733 & 0.23\% & 157.84 \\
F&午後 & 1089430 & 5587(4109,1478) & 4247281 & 61.65 & 47043 & 100\% & 3601.06 \\
T&秋学期土曜午前 & 17765 & 2647(1203,1444) & 58019 & 1.65 & 881 & 10.22\% & 17.58 \\
T&午後 & 23920 & 2561(1079,1482) & 72808 & 1.72 & 334 & 17.86\% & 164.11 \\
\hline
\multicolumn{9}{l}{※最適解の列について：最適解が求められたものは「T」，求められなかったものは「F」と表記している．}\\
\multicolumn{9}{l}{\#1　初期実行可能解が見つかる迄の時間}\\
\multicolumn{9}{l}{\#2　計算終了時の最適な目的関数の値}\\
 \end{tabular}
}
\end{center}
\end{table}
\fi

\begin{table}[H]
\begin{center}
\caption{先行研究での実験結果}
\label{senkou_kekka}
  \begin{tabular}{cr|cccc}
\hline
最適解& \multicolumn{1}{c|}{曜限} & 制約 & 変数(0-1，整数) & nonzeros & 計算時間(秒)\\
\hline\hline
F&春学期月曜午前 & 933306 & 4781(3320,1461) & 3649805 & 3604.03\\
F&午後           & 1156836& 5987(4506,1481) & 4525582 & 3613.53\\
F&火曜午前       & 648062 & 4639(3164,1475) & 2548567 & 3603.72\\
F&午後           & 731761 & 4799(3317,1482) & 2853373 & 3605.06\\
F&水曜午前       & 595910 & 4292(2813,1479) & 2327640 & 3601.08\\
F&午後           & 678082 & 4476(2994,1482) & 2634793 & 3600.13\\
F&木曜午前       & 192757 & 2799(1405,1394) & 744925  & 3602.25\\
F&午後           & 411239 & 3711(2231,1480) & 1590013 & 3600.21\\
F&金曜午前       & 200266 & 3142(1773,1369) & 772967  & 3604.11\\
F&午後           & 871766 & 4981(3500,1481) & 3391847 & 3601.69\\
T&土曜午前       & 36822  & 2628(1362,1266) & 133617  & 225.23 \\
T&午後           & 48320  & 2703(1221,1482) & 171653  & 1282.27\\
\hline
F&秋学期月曜午前 & 706638 & 4235(2753,1482) & 2758070 & 3605.15\\
F&午後           &1026116 & 5861(4379,1482) & 4003702 & 3606.85\\
F&火曜午前       & 888258 & 4922(3479,1443) & 3491939 & 3606.29\\
F&午後           & 926884 & 4835(3353,1482) & 3606133 & 3601.60\\
F&水曜午前       & 469738 & 3756(2312,1444) & 1832968 & 3603.42\\
F&午後           & 723830 & 4719(3244,1475) & 2827852 & 3604.06\\
T&木曜午前       &  80847 & 3063(1581,1482) & 306626  & 752.94 \\
F&午後           & 815102 & 4724(3242,1482) & 3164290 & 3602.20\\
T&金曜午前       &  77837 & 2861(1379,1482) & 296246  & 157.84 \\
F&午後           &1089430 & 5587(4109,1478) & 4247281 & 3601.06\\
T&土曜午前       &  17765 & 2647(1203,1444) & 58019   & 17.58  \\
T&午後           &  23920 & 2561(1079,1482) & 72808   & 164.11 \\
\hline
\multicolumn{6}{l}{※最適解の列について：最適解が求められたものは「T」，}\\
\multicolumn{6}{l}{ 　\hspace{39mm} 求められなかったものは「F」と表記している．}\\
 \end{tabular}
\end{center}
\end{table}


\newpage
\chapter{先行研究の問題点}
\label{mondaiten}
本研究を始めるにあたり，先行研究の検証を行った．
その結果，先行研究には以下のような問題点があることがわかった．
\begin{itemize}
\item 問題点1：考慮制約2「移動時間は指定した時間以内であることが好ましい」を表現する制約式に誤りがある．\\

\if0
\vspace{-7.0mm}
\begin{eqnarray}
&&w_{p,i_1,i_2}\cdot g_{i_1,i_2} \leq \beta_{j_1,j_2}
\label{eqn:seiyaku_first} \\ 
&& \left(\forall p \in P,\:\forall i_1 \in I,\:\forall i_2 \in I,\:\forall j_1 \in J1_p,\:\forall j_2 \in J1_{p+1}\right)\nonumber 
\end{eqnarray}
\fi

　考慮制約2を表す式（\ref{skouryo-2}）においては，左辺に使われている添字が$p,\,i_1,\,i_2$であるのに対し，右辺に使われてる添字は$j_1,j_2$である．
すなわち，左辺と右辺が関連性のない式になっており，この制約式は誤りである．
\vspace{3.0mm}
\item 問題点2：変数が多い．\\
先行研究のモデルには，多くの変数が存在している．
例えば，以下の変数$w_{p,i_1,i_2}$である（再掲）：
\[
\begin{array}{rcl}
w_{p,i_1,i_2} & = & \left\{ 
\begin{array}{ll}
1, & \mbox{$p$限目に教室$i_1$で授業が開講され,}\\
& \mbox{$(p+1)$限目に教室$i_2$で授業が開講されるとき}\\ 
0, & \mbox{それ以外}
\end{array}
\right.\\
\end{array}
\]
　この変数$w_{p,i_1,i_2}$は3つの添字を持つ．
すなわち，この変数$w_{p,i_1,i_2}$は，直積集合$P \times I \times I$の上で展開されるため，変数の数が非常に多くなる．
その結果，計算時間も非常に大きくなっているものと考えられる．
\vspace{3.0mm}
\item 問題点3：考慮制約3「教室内の人が入れ替わる際の混雑ができるだけ発生しないほうが好ましい」を表現する制約式の構造が非常に複雑で，計算に時間がかかっていると思われる．
また，この制約式には誤りもある．\\
\if0
\vspace{-7.0mm}
\begin{eqnarray}
&&((n_{j}-q_{j,j_2}\cdot d_{j,j_2}) + (q_{j_1,j_2} \cdot d_{j_1,j_2} \cdot f_{i_2,i_1})  \nonumber\\
&&+ (n_{j_2} - q_{j_1,j_2}) \cdot h_{j_2}) \cdot (u_{i_1,j} + u_{i_1,j_2} + u_{i_2,j_1} - 2) \cdot d_{j_1,j_2} - z \leq M \cdot \delta_{j,j_1,j_2} \\
&& \hspace{30.0mm} \left(\forall p \in P,\forall i_1 \in I,\forall i_2 \in I,\forall j \in J1_{p},\forall j_1 \in J1_{p},\forall j_2 \in J1_{p+1}\right)\nonumber \\
&& \hspace{30.0mm} \left(i_1 \neq i_2,j \neq j_1,M=十分大きな整数 \right)\nonumber
\end{eqnarray}
\fi

　考慮制約3を表す式（\ref{skouryo-3}）は非常に複雑な構造になっていて，計算に非常に時間を要してしまうものと考えられる．\\

　さらに，この制約式には誤りがある．
以下にその誤りを示す．
\vspace{3.0mm}
\begin{itemize}
\item 項$(n_{j}-q_{j,j_2}\cdot d_{j,j_2})$\\

\vspace{-3.0mm}
　この項では，授業$j$を$p$限に受講している人数から，$(p+1)$限に授業$j_2$を受講している学生の人数を減じることで，
授業$j_2$を受講せずに退室している学生の人数を示そうとしている．
しかし，この成分には教室を表す添字$i$が含まれていない．
従って，授業$j$と$j_2$が開講されている教室が同じ場合，この項の対象であるということが表現できていない．
\vspace{3.0mm}
\item 項$(q_{j_1,j_2} \cdot d_{j_1,j_2} \cdot f_{i_2,i_1})$\\

\vspace{-3.0mm}
　この項では，（$p+1$）限に教室$i_1$で開講される授業$j_2$を受講するために，
$p$限に授業$j_1$が開講されている教室$i_2$から移動する人がいる場合，
その移動時間が混雑の起きうる移動時間を超えるなら，その移動人数は混雑の要因にならないということを示そうとしている．
先行研究では，指定した時間以内に移動できる全ての教室から移動する学生を混雑の対象として考えている．
しかし，この項では特定の1つの教室しか対象にすることができないので，先行研究での意図とは一致していない．
\vspace{3.0mm}
\item 項$(u_{i_1,j} + u_{i_1,j_2} + u_{i_2,j_1} - 2) \cdot d_{j_1,j_2}$\\

\vspace{-3.0mm}
　この項では，この制約に関連する授業が，同じ教室で連続して開講されているかを示している．
本来考慮制約3において対象としたい移動は，図\ref{senko-konzatu}のように，指定した移動時間以内に移動できる教室を全てである．
そのような教室を対象とする場合，指定した移動時間以内に移動できる教室の数だけ変数$u_{i,j}$を増やさなければならない．
しかし，この項では，図\ref{matigai-konzatu}のように，特定の1つの教室に関してしか対応できていない．

\begin{figure}[h]
\begin{center}
		\includegraphics[clip,width=10cm]{kouryo3_old8.eps}
\caption{混雑の対象}
\label{matigai-konzatu}
\end{center}	
\end{figure}
\end{itemize}

\item 問題点4：第4学舎の全ての教室には対応できていない．\\
　先行研究で用いているデータは，表\ref{senkoukyousitu}のように，第4学舎の一般教室である39教室に対応している．
しかし，第4学舎の全ての教室には対応できていないため，データによっては実行可能解を得ることができない可能性がある．
また，OD教室のような特殊教室で開講される授業を除いていることも問題である．
\vspace{3.0mm}
\item 問題点5：授業の扱い方に誤りがある．\\
%先行研究では，全授業の「授業番号・授業名・開講学期・開講曜限・担当教員名・使用教室・履修可能学部学科・配当学部・履修者数」のデータから，授業番号で授業を扱っている．
　授業の中には，1つの授業で複数曜限に渡って開講される授業がある．
先行研究では，そのような授業も，1曜限の授業として扱っているという誤りがあった（表\ref{waruiatukai}）．
また，授業の中には，複数の教員が複数の教室に分かれて開講しているものがある．
先行研究では，そのような授業も1つの教室で開講しているように扱うという誤りもあった．
そのため，使用教室数が実際よりも少なくなっている可能性がある．
また，複数の教室に分かれるはずの学生が1つの教室に集まる扱いになるので，収容人数の多い教室に授業が集中してしまう可能性もある．
さらに，特殊教室で開講される授業を計算対象から除いていることも問題である．
\begin{table}[!h]
\begin{center}
\caption{授業の扱いの例}
\label{waruiatukai}
\begin{tabular}{|c|c|c|}
\hline
授業番号 & 本来の開講曜限 & 先行研究での開講曜限 \\
\hline\hline
60247  & 金曜1，2限 & 金曜1限  \\
60272  & 火曜1限，金曜1限  & 火曜1限\\
\hline
\end{tabular}
\end{center}
\end{table}

\item 問題点6：厳密解が得られていない．\\
　先行研究では，前章で示したモデルを用いて最適化計算を行っているが，24通りのデータのうち6通りに対してしか厳密解を得ることができていない（表\ref{senkou_kekka}）．
なお，厳密解を得られた6通りのうち4通りは，授業数の少ない土曜日のデータでの解であった．
\end{itemize}
\vspace{3.0mm}

\chapter{本研究における教室割当問題}

\section{先行研究からの改良点と本研究の目標}
先行研究では，移動時間の最小値を求める際，目的関数に移動時間を含め，最小化することで解を求めようとしている．
しかし，\ref{mondaiten}章で述べたように，その方法では計算に時間を要し，最適解を求めることができないケースが多くあった．
そこで本研究では，先行研究とは異なる考え方をすることでよい教室割当求めることができる方法がないかどうかを考察した．

先行研究では，全学生の移動時間の総和を最小化する教室割当を行っていた．
これに対し，本研究では，全学生の最大の移動時間を最小化することにする．
すなわち，本研究では教室割当問題を次のように定義し，これを定式化して，求解する．\\
\begin{center}
\fbox{
\begin{tabular}{c}
各授業の開講曜限が定められているとき，各休み時間における学生の\\最大の移動時間を最小化するような，授業に対する教室の割当を求めよ．
\end{tabular}
}
\end{center}
\vspace{5.0mm}

本研究では，この問題の最適解を求めるためのアプローチとして，最適化問題の中に移動時間の上限を定めるパラメータを用意する．
そして，そのパラメータを調整しながら問題を解き，実行可能解が得られるパラメータの最小値を求める．
これが，最大の移動時間の最小化となる．

なお，本研究では，最適化対象については先行研究と同様の考え方をしている．
すなわち，1日を午前・午後に分け，1週間が月曜から土曜の6日，そして1年が春・秋の2学期に分けた，合計24通りの最適化を行っている．

\if0
\section{解法}
先行研究と同様に，本研究では最大の移動時間を最小化する教室割当問題を，重み付き制約充足問題（WCSP）として扱い，また，定式化した数理計画問題を解くために，厳密解法を用いている．
\fi

\section{問題の定式化}

本研究では，以下のように教室割当問題を定式化して最適化を行っている．
制約式には先行研究からの変更点も記す．

\begin{itemize}
\item 集合と添字・パラメータ・変数
\begin{itemize}
\item 集合・添字\\

\vspace{-3.0mm}
\begin{tabular}{ll}
$p \in P$       & ： 時限とその集合  \\
$p' \in P'$   & ：最終時限を除いた時限とその集合  \\
$j \in J$       & ： 授業とその集合  \\
$j \in JN_{p}$　 &： $p$限目に開講される授業とその集合  \\
$j \in NJ$　   &：一般授業とその集合  \\
$j \in SJ$     &：特殊教室を指定する授業とその集合  \\
$i \in I$        &： 教室とその集合  \\
$i \in SI$　　  &： 特殊教室とその集合  \\
$(i,j) \in D$　  &： 特定の教室を指定する授業の組とその集合  \\
$j \in L$　　　  &： 特別連続授業とその集合  \\
$j' \in J'$　&：教室希望のある授業とその集合  \\
$i'\in I'_{j'}$　&：授業$j'$が開講を希望する教室とその集合  \\
$pc \in PC$　　  &：考慮制約の番号とその集合  \\
$pa \in PA$  　　&：考慮制約の重みとその集合  \\
\end{tabular}
\vspace{5.0mm}
\item パラメータ\\
\vspace{-7.0mm}
\[
\begin{array}{rcl}

m_{i} & = & 
\begin{array}{ll}
 \mbox{教室$i$の定員数} 
\end{array}
\\


n_{j} & = & 
\begin{array}{ll}
 \mbox{授業$j$の受講者数} 
\end{array}
\\


t_{i_1,i_2} & = & 
\begin{array}{ll}
 \mbox{教室$i_1$と教室$i_2$間での所要移動時間} 
\end{array}
\\


q_{i_1,i_2} & = & 
\begin{array}{ll}
 \mbox{授業$i_1$と授業$i_2$の双方を受講する学生数} 
\end{array}
\\


r & = & 
\begin{array}{ll}
 \mbox{全ての移動で守る移動時間} 
\end{array}
\\


z & = & 
\begin{array}{ll}
 \mbox{混雑が起きると予測される人数} 
\end{array}
\\


d_{j_1,j_2} & = & \left\{ 
\begin{array}{ll}
	1, & \mbox{$p$限目に授業$j_1$を，$(p+1)$限目に授業$j_2$を受講する学生が存在するとき} 		\\
	0, & \mbox{それ以外}
\end{array}
\right. \\


\end{array}
\]


\vspace{5.0mm}
\item 変数\\
\[
\begin{array}{rcl}


 u_{i,j} & = & \left\{ 
\begin{array}{ll}
1, & \mbox{教室$i$に授業$j$が割り当てられているとき} \\
0, & \mbox{それ以外}
\end{array}
\right. \\


 \alpha_{j_1,j_2} & = & \left\{ 
\begin{array}{ll}
1, & \mbox{$p$限目に授業$j_1$を受講していて，$(p+1)$限目に授業$j_2$を受講せずに}\\
& \mbox{退室する学生集団と，$p$限目に授業$j_1$を受講しておらず，かつ}\\
& \mbox{$(p+1)$限目に授業$j_2$を受講するために入室する学生集団の}\\
& \mbox{合計人数が$z$人を超えて，混雑が起きる可能性が高いとき}\\
0, & \mbox{それ以外}
\end{array}
\right.
\end{array}
\]
\end{itemize}
\vspace{3.0mm}

\item 制約条件\\
\begin{itemize}
\item{絶対制約}\\
\begin{itemize}

\item {\bf  [絶対制約1] : 1つの曜限における各教室には2つ以上の授業を割り当てられない．}\\
　同じ曜限において，各教室に2つ以上の授業が割り当てられないようにするため，
教室$i$について，次の制約を与える：

\vspace{-3.0mm}
\begin{eqnarray}
\label{hzettai1} 
&&\sum_{j \in JN_{p}} u_{i,j} \leq 1 \hspace{5.0mm}
\quad \left (\forall p \in P, \: \forall i \in I \right)
\end{eqnarray} 

\vspace{5.0mm}
この制約は，先行研究の絶対制約1「1つの曜限における各教室には2つ以上の授業を割り当てられない」を改良した制約式である．
先行研究では，時限$p$時に授業$j$が割り当てられているときに1となるパラメータ$e_{p,j}$を用意している．
対して本研究では，授業$j$に時限の要素も組み込んだ$JN_p$という集合を用いることで，同じ意味の制約としている
\footnote{本研究の制約式では，授業は全て$JN_p$を用いている．これにより先行研究の$j$の集合は全て$P,JN_P$の集合となっている．}
．
\vspace{3.0mm}
\item {\bf  [絶対制約2] : 各授業には必ず1つの教室を割り当てなければならない．}\\

\vspace{-5.0mm}
　ある曜限に存在する1つの授業に対して2つ以上の教室を割り当てないようにするため，
また，1つの授業に1つも教室が割り当てられないことを防ぐため，授業$j$について，次の制約を与える：

\vspace{-3.0mm}
\begin{eqnarray}
\label{hzettai2} 
&&\sum_{i \in I} u_{i,j} = 1 \hspace{5.0mm}
\quad \left (\forall p \in P, \: \forall j \in JN_{p} \right)
\end{eqnarray} 

\vspace{5.0mm}
この制約は先行研究と同じ制約式を用いている．
\vspace{3.0mm}
\item {\bf  [絶対制約3] : 受講人数が教室の定員を超えて教室に授業を割り当ててはいけない．}\\

\vspace{-5.0mm}
　受講人数が各教室の定員を越えないようにするため，
次の制約を与える：

\vspace{-3.0mm}
\begin{eqnarray}
\label{hzettai3} 
&&\sum_{i \in I} u_{i,j}\cdot m_{i} \geq n_{j} \hspace{5.0mm}
\quad \left (\forall p \in P, \: \forall j \in JN_{p}\right)
\end{eqnarray}

\vspace{5.0mm}
この制約は先行研究と同じ制約式を用いている．
\vspace{3.0mm}
\item {\bf  [絶対制約4] : 特定の授業は指定された教室で開講されなければならない．}\\

\vspace{-5.0mm}
　本制約は，特定の設備を必要とする授業にその設備が整った指定されている教室を割り当てるための制約である．
教室$i$に授業$j$が割り当てられなければならないとき，次の制約を与える：

\vspace{-3.0mm}
\label{hzettai4} 
\begin{eqnarray}
&&u_{i,j} = 1 \hspace{5.0mm}
\quad \left(\forall (i,j) \in D\right)
\end{eqnarray}

\vspace{5.0mm}
この制約は先行研究と同じ制約式を用いている．
\vspace{3.0mm}
\item {\bf  [絶対制約4\_2] : 指定された授業でないものは特殊教室で開講されてはいけない．}\\

\vspace{-5.0mm}
　特殊教室で一般的な授業を行うことは好ましくない．
本制約は，一般的な授業に特殊教室を割り当てることを避けるための制約である．
特殊教室$i$を一般的な授業$j$に割り当ててはいけないとき，次の制約を与える：

\vspace{-3.0mm}
\begin{eqnarray}
\label{hzettai42} 
&&u_{i,j} = 0 \hspace{5.0mm}
\quad \left(\forall p \in P, \: \forall j \in JN_{p}\setminus SJ, \: \forall i \in SI\right )
\end{eqnarray}

\vspace{3.0mm}
この制約は，特殊教室，及び特殊授業を扱うために本研究において新しく追加した制約式である．

\vspace{3.0mm}
\item {\bf  [絶対制約5] : 移動時間は指定した時間以内でなければならない．}\\

\vspace{-5.0mm}
　関西大学の休み時間は10分と非常に短い．
本制約は，休み時間を移動以外のことに費やせるように，移動時間を制限するための制約である．

\vspace{-3.0mm}
\begin{eqnarray}
\label{hzettai5} 
&&u_{i_1,j_1} + u_{i_2,j_2} \leq 1\\
&&\left(\forall p \in P, \: \forall i_1 \in I,\: \forall i_2 \in I,\: \forall j_1 \in JN_{p},\: \forall j_2 \in JN_{p+1},\:t_{i1, i2} \ge r, \: d_{j1, j2} = 1\right)\nonumber
\end{eqnarray}

\vspace{3.0mm}
この制約は，先行研究の考慮制約2「移動時間は指定した時間以内であることが好ましい」を改良したものである．
先行研究では，一定以上の休み時間を確保できない学生が存在する可能性がある．
本研究では，この制約を絶対制約にすることで全学生の移動時間を一定以下に制限し，全学生に一定時間以上の休み時間を確保している．

　この改良により，前章の問題点1『考慮制約2「移動時間は指定した時間以内であることが好ましい」の制約式に誤りがある』を解消している．
またこの制約式は，3つの添字を持つ変数$w_{p,i_1,i_2}$を用いず，他の制約式でも用いているパラメータ$d_{j_1,j_2}$を用いている．
さらに，2つの添字を持つ変数$\beta_{j_1,j_2}$も用いていない．
これらのことより，前章の問題点2「変数が多い」も解消している．

\vspace{3.0mm}
\item {\bf  [絶対制約6] : 特別連続授業は同じ教室で開講されなければならない．}\\

\vspace{-5.0mm}
　特別連続授業（授業内容が同一，または非常に関連性の高い2限以上連続で開講される授業）は双方を受講している学生が多い．
従って，特別連続授業同一の教室で開講されるべきである．
本制約は，特別連続授業を同一教室で行うための制約である．

\vspace{-3.0mm}
\begin{eqnarray}
\label{hzettai6} 
&&u_{i_1,j_1}= u_{i_2,j_2} \quad \left(i \in I ,\: (j_1, j_2) \in L \right)
\end{eqnarray}

\vspace{3.0mm}
この制約は，先行研究の考慮制約1「特別連続授業は同じ教室で開講されることが好ましい」を改良したものである．
本研究では，この制約を絶対制約にすることで，大勢の学生が移動する可能性を低くしている．
また，この制約は，先行研究の考慮制約1「特別連続授業は同じ教室で開講されることが好ましい」で用いられている変数$\alpha_{j_1,j_2}$を用いずに定式化している．
従って，これは前章の問題点2「変数が多い」を解消している．
\end{itemize}

\vspace{5.0mm}
\item 考慮制約\\
\vspace{-5.0mm}
\begin{itemize}
\item {\bf  [考慮制約1] : 教室内の人が入れ替わる際の混雑ができるだけ発生しないほうが好ましい．}\\

\vspace{-5.0mm}
　昼休みを除く各時限間の教室では，移動して教室に入ってくる学生と，授業が終わって教室から出て行く学生によって混雑が起きる可能性がある．
しかし，混雑は移動時間の増加につながるため，できるだけ避けたいことである．
本制約は，授業間移動によって発生する混雑による移動時間の増加を，できるだけ避けるための制約である．\\

\vspace{-10.0mm}
\begin{eqnarray}
\label{hkouryo1} 
&&\left(u_{i,j_1} + u_{i,j_2} - 1\right) \le \alpha_{j_1, j_2}  \\
&&(\forall p' \in P', \: \forall j_1 \in JN_{p'}, \: \forall j_2 \in JN_{p'+1} ,\nonumber \\
&&\hspace{30mm} (n_{j_1} - q_{j_1, j_2}) + (n_{j_2} - q_{j_1, j_2})) - z > 0, \: d_{j_1, j_2} = 1)\nonumber 
%&&\left(\forall p' \in P', \: \forall j_1 \in JN_{p'}, \: \forall j_2 \in JN_{p'+1} \right)\nonumber \\
%&&\left((n_{j_1} - q_{j_1, j_2}) + (n_{j_2} - q_{j_1, j_2})) - z > 0, \: d_{j_1, j_2} = 1\right)\nonumber 
\end{eqnarray}

\begin{eqnarray}
\label{hkouryo12} 
&&k_1= \sum_{p' \in P'} \sum_{j_1 \in JN_{p'}} \sum_{j_2\_ \in JN_{p'}} \alpha_{j_1, j_2}
\end{eqnarray}

\vspace{3.0mm}
この制約は，先行研究の考慮制約3「教室内の人が入れ替わる際の混雑ができるだけ発生しないほうが好ましい」を改良した制約である．
混雑のタイミングは，対象教室の授業が延長されたり，遠くの教室の授業が早く終了するなど，様々な要因があるため，予測することは非常に難しい．
そのため，本研究では，図\ref{hkonzatu}のように，混雑の原因となる人数は，対象教室を出入りする全ての学生の合計としている．

　（\ref{hkouryo1}），（\ref{hkouryo12}）では，移動人数が混雑が発生すると考えられる人数である$z$人を越えると，条件を違反した指標$\alpha_{j_1, j_2}$が1となり，その合計が違反点数$k_1$となる．

\begin{figure}[h]
\begin{center}
		\includegraphics[clip,width=10cm]{kouryo3_new8.eps}
\caption{本研究における混雑の対象}
\label{hkonzatu}
\end{center}	
\end{figure}

　この考え方より，この制約は「対象教室で起こり得る最大の混雑を抑える」ということを示している．
この改良によって，制約式の構造を簡素化することができ，
前章の問題点3『考慮制約3「教室内の人が入れ替わる際の混雑ができるだけ発生しないほうが好ましい」の構造が非常に複雑で，計算に時間がかかっている．また，この制約式に誤りがある』を解消している．
また，この制約式は3つの添字を持つ変数$\delta_{j,\;j_1,\;j_2}$から，2つの添字を持つ変数$\alpha_{j_1,j_2}$に変更している．
これにより，前章の問題点2「変数が多い」を解消していることがわかる．
この変更により，計算時間を短縮できることが期待できる．
\vspace{5.0mm}
\item {\bf  [考慮制約2] : 希望教室があれば，その教室で授業を開講したい．}\\

\vspace{-5.0mm}
　学生や教員には，何らかの理由（研究室が近いなど）で授業を開講してほしい教室があると思われる．
本制約は，できるだけ希望した教室で授業を開講するための制約である．

\vspace{-3.0mm}
\begin{eqnarray}
\label{hkouryo2} 
&&k_2= \sum_{j' \in J'}  \sum_{i' \in I'_{j'}}u_{i', j'}
\end{eqnarray}

\vspace{5.0mm}
この制約は，希望教室で授業を開講するために，本研究で新しく追加した制約である．
本制約では，ひとつの授業で複数の教室を希望することができる．
しかし，同じ曜限で同じ教室を希望する授業が複数あった場合や，ひとつの授業で複数の希望教室がある場合，
または教室希望を叶えると他の教室の割当が不可能になってしまう場合，絶対制約を満たすことができず，解を求められない．
本制約はそのような場合に対応するため，考慮制約となっている．

\vspace{5.0mm}
\end{itemize}
\end{itemize}
\item 目的関数\\
目的関数は，考慮制約1を満たせていない場合に発生する違反指標の合計$k_1$と，
考慮制約2を満たせた場合の指標の合計$k_2$に，それぞれ重み$pa_1$，$pa_2$を乗じたものの合計値を最小化するように定める．
ただし，$k_2$については制約を満たした場合に指標が発生するので，重み$pa_2$は必ず負の値でなければならない．
\begin{eqnarray}
\label{hmokuteki} 
&&{\rm minimize} \quad \sum_{pc \in PC} (pa_{pc} \cdot k_{pc}) \label{eqn:mokuteki}
\end{eqnarray}

本問題では，全学生の移動時間に上限を設けている．
そのため，各学生の移動時間の総和を最小化する事は行わない．
その結果，本問題では目的関数に$v_{i_1,i_2}$を含んでいない．
これにより，前章の問題点2「変数が多い」を解消している．
\end{itemize}

この問題を解くことは，学生全員が$r$秒以下で移動できるような教室割当問題を解くということと同意である．
$r$を変化させることで，学生の最大の移動時間が変化する．
従って，$r$を小さくしていくことで，学生の最大の移動時間の最小値を求めることができる．
本研究では，この解を求めることが，教室割当問題の解を求めることであると考えている．

\section{使用教室と対象授業}
本研究では以下のデータを使って最適化を行っている．
\begin{itemize}
\item 使用教室\\
　本研究では，第4学舎の一般教室である44教室（表\ref{hkyousitu}）と，OD教室などの特殊教室である23教室（表\ref{tokushu}）の合計67教室を計算対象としている．
これより，前章の問題点4「第4学舎の全ての教室に対応できていない」を解消し，第4学舎で開講される全ての授業に対応することができている．\\
　なお，本研究で扱っている特殊教室を付録\ref{hurokupara}の表\ref{tokushu}に示す．
また，教室間の移動時間であるパラメータ$t_{i_1,i_2}$は，表\ref{paramt}のように定めている．


\begin{table}[!h]
\begin{center}
\caption{本研究で扱っている一般教室}
\label{hkyousitu}
\begin{tabular}{|c|c|c|c|c|}
\hline
1階 & 2階 & 3階 & 4階 & その他\\
\hline\hline
\ 4-101  & \ 4-201A & \ 4-301  &  \ 4-401  & *4-501  \\
\ 4-102  & *4-201B  & \ 4-302  &  \ 4-402  &\ 4-502  \\
\ 4-103  & \ 4-202  & \ 4-303  &  \ 4-403  &\ 4-3101 \\
\ 4-104  & \ 4-203  & \ 4-304  &  \ 4-404  &\ 4-3201 \\
\ 4-105  & \ 4-204  & \ 4-305  &  \ 4-405  &\ 4-3202 \\
\ 4-106  & \ 4-205  & \ 4-306  &  \ 4-406  & *4-3401 \\
\ 4-107  & \ 4-206  & \ 4-307  &  \ 4-407  & *4-3402 \\
         & \ 4-207  & \ 4-308  &  \ 4-408  & *4-3403 \\
         & \ 4-208  &          &           &\ 4-4A   \\
         & \ 4-209  &          &           &\ 4-4B   \\
         & \ 4-210  &          &           &         \\
\hline
\multicolumn{5}{l}{*：本研究で追加した教室}\\
\end{tabular}
\end{center}
\end{table}


\item 対象授業\\
　理工系学部で開講される全授業を授業番号によって扱っている．
また，本研究では，特殊教室で行われる授業も同様に扱っている．

　授業の中には，１つの授業であるにも関わらず，複数の曜限で開講しているものがある．
本研究では，{\bf 各授業の授業番号に学期・曜限の情報を付加させ，授業を分割する}ことで，このような授業に対応している．
さらに，複数の教員が複数の教室を使用して開講している授業が存在している．
しかし，この授業は，絶対制約1「1つの曜限における各教室には2つ以上の授業を割り当てられない」を守ることができない．
そこで，本研究では，{\bf 「複数の教員が担当し，かつ複数の教室を扱っているとき，教員と教室の少ない方の数だけ授業を分割する」}ということを行っている．
これにより，本研究では，ひとつの授業を「授業番号\_学期・曜限\_分割番号」と表示している．
それぞれの要素は，表\ref{jugyou}のように構成される．

\vspace{-3mm}

\begin{table}[H]
\caption{授業の扱い方}
\label{jugyou}
\begin{center}
\begin{tabular}{rl}
\hline
授業番号 & 授業に割り当てられている番号\\
\hline
学期 & o：春学期に開講\\
 & x：秋学期に開講\\
\hline
曜日 & 月曜から土曜までそれぞれ「Mo,Tu,We,Th,Fr,Sa」\\
\hline
時限 & 開講される時限\\
\hline
分割番号 & 授業を分割した時，分割したことを示すための番号\\
\hline
\end{tabular}
\end{center}
\end{table}

\vspace{-10mm}
分割番号は，分割した分だけ数値が示している．
例えば，3つに分割されてる授業は，分割番号が1, 2, 3となっている授業がそれぞれ存在しているということである．
その際，履修人数，及び移動人数は分割した数だけ等分されている．
以下に授業の例を示す．\\
\vspace{-5mm}
\begin{itemize}
\item 授業番号00561（春学期の月曜2限に開講，担当教員1人，使用教室1つ）\\
これは，最も一般的な授業の形式である．
「{\bf 00561\_oMo2\_1}」と示す．
\item 授業番号65392（春学期の月曜3, 4, 5限に開講，担当教員1人，使用教室1つ）\\
この授業は連続授業である．
3, 4, 5限にそれぞれ対応すると，「{\bf 65392\_oMo3\_1, 65392\_oMo4\_1, 65392\_oMo5\_1}」となる．
\item 授業番号65180（春学期の月曜2限に開講，担当教員2人，使用教室2つ）\\
この授業は複数の教員が担当し，複数の教室を使って開講している．
この授業の場合，教員と教室の数が共に2つなので，授業は2つに分割される．
よって，この授業は，「{\bf 65180\_oMo2\_1, 65180\_oMo2\_2}」となる．
\item 授業番号60273（春学期の火曜1限，金曜1限に開講，担当教員1人，使用教室1つ）\\
この授業は，複数の曜限で開講されている．
それぞれの曜限に対応すると，\\
「{\bf 60273\_oTu1\_1, 60273\_oFr1\_1}」となる．
\item 授業番号65186（春学期の月曜3限，金曜2限に開講，担当教員3人，使用教室3つ）\\
まず，この授業は複数の教員と複数の教室がある．
この授業の場合，教員と教室の数が共に3つなので，授業は3つに分割される．
また，複数の曜限で開講されているので，それぞれに対応すると，「{\bf 62227\_oMo3\_1, 62227\_oMo3\_2, 62227\_oMo3\_3, 62227\_oFr2\_1, 62227\_oFr2\_2, 62227\_oFr2\_3}」となる．
\end{itemize}
\vspace{3.0mm}
この処理により，前章の問題点5「授業の取り扱いに誤りがある」を解消している．

　表\ref{k:normal_information}に，本研究で扱う各曜限の授業数を示す．
\begin{table}[H]
\caption{各学期曜限の授業数}
\label{k:normal_information}
\begin{center}
\begin{tabular}{c|cc|ccc|cc|ccc}
\hline
 & \multicolumn{2}{|c}{春学期午前} &\multicolumn{3}{|c}{春学期午後} &\multicolumn{2}{|c}{秋学期午前} &\multicolumn{3}{|c}{秋学期午後} \\
\hline
曜日　& 1限 & 2限 & 3限 & 4限 & 5限 &  1限 & 2限 & 3限 & 4限 & 5限\\
\hline
月曜  & 21  & 36  & 45 & 32  & 25  & 24  & 30 & 38  & 33 & 18 \\
火曜  & 35  & 39  & 33 & 34  & 24  & 25  & 37 & 35  & 31 & 20 \\
水曜  & 22  & 34  & 34 & 26  & 14  & 24  & 32 & 36  & 28 & 13 \\
木曜  & 20  & 23  & 21 & 25  & 24  & 17  & 34 & 36  & 29 & 24 \\
金曜  & 25  & 35  & 39 & 38  & 21  & 18  & 35 & 44  & 33 & 21 \\
土曜  & 11  & 18  & 16 & 11  & 5   & 12  & 19 & 16  & 13 & 4  \\
\hline
\end{tabular}
\end{center}
\end{table}





\end{itemize}



\input{jikken.tex}


\chapter{おわりに}
本研究では，先行研究\cite{先行研究}の定式化の誤りを正し，また異なる視点から教室割当問題を定式化しそれを最適化ソルバーで解くことで，関西大学の理工系学部で開講されている授業に対する，最大の移動時間を最小化するような教室割当を求めることができた．
また，希望教室を設定することで，学生や教員にとって都合のよい教室割当を実現することができることを確認した．
さらに，本研究での教室割当問題の定式化は，関西大学理工系に限らず，様々な大学，学部で使用することができるように作成されている．

付録\ref{huroku}の図\ref{oMo12}～図\ref{oTu12_2}に，全実験における移動時間ごとの学生数を示している．
これらを見ると，最大の移動時間を最小化することで全体の移動時間もある程度小さくなっているものの，移動時間ごとの学生数はまばらになっていることがわかる．
従って，今後の課題として，最大の移動時間を最小化した上で，移動時間の総和の最小化をすることができるのではないかと考えられる．
また，本研究における教室割当においては，本研究で提案した定式化に沿ったデータファイルを作成しなければならない．
従って，本研究における教室割当を求める際に用いることのできるインターフェイスを開発することも必要となるだろう．

\newpage
\chapter*{謝辞}

本研究を進めるに当たり，ご指導頂いた檀寛成助教に深く感謝致します．

また，日常の議論を通じて多くの知識や示唆を頂いたシステムモデリング研究室の皆様へ心から感謝の気持ちと御礼を申し上げて，謝辞にかえさせていただきます．

\begin{flushright} 
平成27年2月13日
\end{flushright} 


\newpage
\begin{thebibliography}{9}

\bibitem{AMPL}
R. Fourer, D. M. Gay，B. W. Kernighan, AMPL A Modeling Language for Mathmatical Programming Second Edition, Thomson Learning (2003)．

\bibitem{数理計画入門}
福島雅夫，数理計画入門，朝倉書店 (1996)．

\bibitem{CSP}
茨木俊秀，メタヒューリスティクスによる汎用問題解決システムの構築，\\
平成13年度～平成15年度 科学研究費補助金 基盤研究(B)(2)・研究成果報告書 (2004)．

\bibitem{CPLEX}
IBM ILOG CPLEX Optimizer,\\
 http://www-01.ibm.com/software/integration/optimization/cplex-optimizer/\\
 （2015年2月9日確認）．

\bibitem{dadasenko}
井筒朗，大学における時間割作成問題の汎用ソルバーを用いた求解可能性，関西大学工学部平成19年度卒業論文 (2008)．

\bibitem{GLPK}
GLPK -GNU Project- Free Software Foundation (FSF),　　　　　　　　　　　　
 http://www.gnu.org/software/glpk/ （2015年2月4日確認）．

\bibitem{dadasan}
濱田佑，授業再編を考慮した時間割作成ソフトウェアの開発，関西大学環境都市工学部平成25年度卒業論文 (2013)．

\bibitem{ハンドブック}
久保幹雄，田村明久，松井知己 編集，応用数理計画ハンドブック，朝倉書店 (2002)．

\bibitem{kurousitemituketa}
前川廣太郎，澤勢一史，延原肇，教室移動時間最適化のための群集団移動と多重解像ダイクストラ法を取り入れたマルチエージェントシステムと遺伝的アルゴリズムの開発，筑波大学大学院システム情報工学研究科知能機能システム専攻 (2012)．

\bibitem{先行研究}
鈴木健太，移動時間を最小化する教室割当問題の定式化と求解，関西大学環境都市工学部平成26年度卒業論文 (2014)．


\end{thebibliography}









\appendix
\def\thechapter{\Alph{chapter}}

\input{huroku.tex}

\end{document}





